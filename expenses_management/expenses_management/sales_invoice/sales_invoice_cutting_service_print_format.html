<!DOCTYPE html>
{% set customer = doc.customer %}
{% set ctax_id = frappe.get_doc("Customer", customer).tax_id %}
{% if doc.customer_address %}
  {% set addr = frappe.get_doc("Address", doc.customer_address) %}
{% endif %}
{% set comp = frappe.get_doc("Company", doc.company) %}
{% set company_logo = "/assets/expenses_management/images/logo.jpeg" %}
{% set time = (doc.posting_time|string)[:5] %}
{% if time[1] == ':' %}
  {% set time = '0' + time[:4] %}
{% endif %}
{% set color = "#333333" %}
{% if comp.cr_number %}
  {% set cr = comp.cr_number | string %}
{% endif %}

{% set links = frappe.get_all('Dynamic Link', filters={'link_doctype': 'Company', 'link_name': doc.company, 'parenttype': 'Address'}, fields=['parent']) %}
{% if links %}
  {% set address = frappe.get_doc("Address", links[0].parent) %}
{% endif %}

<style>
  table {
    border: 1px solid black;
    border-spacing: 0;
    border-collapse: collapse;
    font-size: 20px;
  }

  th, td {
    width: 140px;
    line-height: 0.9;
    font-size: 12px;
    padding: 2px;
    margin: 0mm;
  }

  .ar {
    text-align: right;
  }

  .styled-table {
    border-collapse: collapse;
    margin: 2px -2px;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.10);
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid #dddddd;
  }

  .styled-table tbody tr:last-of-type {
    border-bottom: 2px solid {{color}};
  }

  .styled-table th, .styled-table td {
    border: none;
  }

  .styled-table tbody tr:nth-of-type(even) {
    background-color: #f3f3f3;
  }

  table tbody tr:nth-of-type(even) {
    background-color: #f3f3f3;
  }

  .print-format {
    padding: 0.1in;
    font-size: 12px;
    direction: ltr;
  }

  .fixed-footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%;
    text-align: center;
    background: transparent;
  }

  .fixed-footer img {
    width: 100%;
    max-width: 100%;
    height: auto;
  }

  .cutting-service-section {
    background-color: #e8f5e9;
    border: 2px solid #4caf50;
    border-radius: 8px;
    padding: 10px 15px;
    margin-top: 10px;
    text-align: center;
  }

  @media print {
    .print-format-gutter {
      margin-left: 2mm;
      margin-right: 2mm;
      margin-top: 10mm !important;
    }
    .print-format {
      margin-left: 5mm;
      margin-right: 5mm;
      margin-top: -10mm !important;
      margin-bottom: 0mm !important;
      padding: 0 !important;
    }
  }

  @page {
    size: auto;
    margin: 5mm 0mm 14mm 0mm;
  }
</style>

<table class="items" style="width:100%;border:none;">
  <thead style="width:100%;border:none;">
    <tr style="width:100%;border:none;">
      <td colspan="9" style="width:100%;border:none;">
        <div style="width:100%;">
          <table style="width: 100%; border: none !important;">
            <tr style="border: none !important;">
              <!-- Left: Logo -->
              <td style="width: 20%; vertical-align: middle; border: none !important; text-align: left; padding: 10px;">
                <div style="text-align: left;">
                  <img src="{{ company_logo }}" style="height: 90px; width: auto;" alt="Company Logo" />
                </div>
              </td>
              <!-- Center: Title with decorative styling -->
              <td style="width: 60%; vertical-align: middle; border: none !important; text-align: center;">
                <div style="text-align:center; padding: 15px 0;">
                  {% if doc.is_return == 0 %}
                    <div style="font-size:28px; font-weight:bold; color:#1a5276; letter-spacing: 1px;">
                      فاتورة ضريبية / TAX INVOICE
                    </div>
                  {% else %}
                    <div style="font-size:28px; font-weight:bold; color:#1a5276; letter-spacing: 1px;">
                      مرتجع / Credit Note
                    </div>
                  {% endif %}

                  {% if doc.docstatus == 2 %}
                    <div style="color:#c0392b; font-size:14px; font-weight:bold; margin-top:8px; padding: 4px 12px; background-color: #fadbd8; border-radius: 4px; display: inline-block;">CANCELLED / فاتورة ملغية</div>
                  {% elif doc.docstatus == 0 %}
                    <div style="color:#d35400; font-size:14px; font-weight:bold; margin-top:8px; padding: 4px 12px; background-color: #fdebd0; border-radius: 4px; display: inline-block;">DRAFT / فاتورة مسودة</div>
                  {% endif %}
                </div>
              </td>
              <!-- Right: Empty -->
              <td style="width: 20%; vertical-align: middle; border: none !important;">
              </td>
            </tr>
          </table>
        </div>
      </td>
    </tr>
  </thead>

  <tr style="border:none;">
    <td colspan="9" style="border:none;">
      {% set tax = "{:,.2f}".format(doc.total_taxes_and_charges) %}
      {% set last_total = "{:,.2f}".format(doc.grand_total) %}

      <table style="width:102%;border:none;margin-top:5px;margin-left:-6px;margin-right:-3px;">
        <tr>
          <td style="border:none;">
            <table class="styled-table" style="width:100%;height:101%;margin-top:10px;margin-left:4px;">
              <tr>
                <td style="font-size:10px;text-align:center;">{{ doc.due_date or '' }}</td>
                <td style="font-size:10px;text-align:center;">Due Date / الاستحقاق</td>
                <td style="font-size:10px;text-align:center;">{{ doc.posting_date }}</td>
                <td style="font-size:10px;text-align:center;">Issue Date / الاصدار</td>
                <td class="ar" style="font-size:10px;text-align:center;">{{ doc.name }}</td>
                <td style="font-size:10px;text-align:center;">Invoice No / رقم الفاتورة</td>
              </tr>
            </table>
          </td>
        </tr>
      </table>

      <table style="width:102%;border:none;margin-top:5px;margin-left:-6px;margin-right:-3px; table-layout: fixed;">
        <tr>
          <!-- Customer Info -->
          <td style="width:49%;border:none;position:relative;">
            <table class="styled-table" style="height:100%;margin-left:-5px; margin-top:5px">
              {% if doc.customer %}
              <tr style="height:10px;">
                <td colspan="3" style="padding:0px !important">
                  <table style="width: 100%; table-layout: fixed; border:none;">
                    <tr style="border:none;">
                      <td style="width: 15%; font-size:10px;">To / الى</td>
                      <td style="font-size:10px;text-align:center;width:85%;">{{ doc.customer }}</td>
                    </tr>
                  </table>
                </td>
              </tr>
              {% endif %}

              {% if doc.customer_name %}
              <tr style="height:10px;">
                <td colspan="3" style="padding:0px !important">
                  <table style="width: 100%; table-layout: fixed; border:none;">
                    <tr style="border:none;">
                      <td style="width: 15%; font-size:10px;">Customer / العميل</td>
                      <td style="font-size:10px;text-align:center;width:85%;">{{ doc.customer_name }}</td>
                    </tr>
                  </table>
                </td>
              </tr>
              {% endif %}

              {% if ctax_id %}
              <tr>
                <td style="font-size: 10px; text-align: left;">TAX ID / الرقم الضريبي</td>
                <td style="font-size: 10px; text-align: center;">{{ ctax_id }}</td>
              </tr>
              {% endif %}

              {% if addr and addr.address_line1 %}
              <tr>
                <td colspan="1" style="font-size:10px;">Address / العنوان</td>
                <td colspan="1" style="font-size:10px;text-align:center;">{{ addr.address_line1[:30] }}</td>
              </tr>
              {% endif %}

              {% if addr and addr.phone %}
              <tr>
                <td colspan="1" style="font-size:10px;">Phone / الهاتف</td>
                <td colspan="1" style="font-size:10px;text-align:center;">{{ addr.phone }}</td>
              </tr>
              {% endif %}
            </table>
          </td>

          <!-- Company Info -->
          <td style="border:none;">
            <table class="styled-table" style="width:100%;height:100%;margin-top:5px;margin-left:4px;">
              {% if doc.company %}
              <tr>
                <td colspan="2" style="font-size:10px;">From / من</td>
                <td colspan="2" style="font-size:10px;text-align:center;">{{ doc.company }}</td>
              </tr>
              {% endif %}

              {% if doc.company_tax_id %}
              <tr>
                <td colspan="2" style="width:18%;font-size:10px;">TAX ID / الرقم الضريبي</td>
                <td colspan="2" style="line-height:0.8;text-align:center;font-size:10px;">{{ doc.company_tax_id }}</td>
              </tr>
              {% endif %}

              {% if comp.cr_number %}
              <tr>
                <td colspan="2" style="font-size:10px;">CR Number / السجل التجاري</td>
                <td colspan="2" style="line-height:0.8;text-align:center;font-size:10px;">{{ comp.cr_number }}</td>
              </tr>
              {% endif %}

              {% if address and address.address_line1 %}
              <tr>
                <td colspan="2" style="font-size:10px;">Address / العنوان</td>
                <td colspan="2" style="text-align:center;font-size:10px;">{{ address.address_line1[:30] }}</td>
              </tr>
              {% endif %}

              {% if comp.phone_no %}
              <tr>
                <td colspan="2" style="line-height:0.8;font-size:10px;">Phone / الهاتف</td>
                <td colspan="2" style="line-height:0.8;text-align:center;font-size:10px;">{{ comp.phone_no }}</td>
              </tr>
              {% endif %}
            </table>
          </td>
        </tr>
      </table>
    </td>
  </tr>

  <!-- Items Header -->
  <tr style="background-color:{{color}};border-bottom:none;">
    <td colspan="5" style="text-align:left;color:white;font-size:14px;border-top-left-radius:10px">Item and Services Description</td>
    <td colspan="4" style="text-align:right;color:white;font-size:14px;border-top-right-radius:10px">توصيف السلعة أو الخدمة</td>
  </tr>
  <tr style="font-weight:bold;text-align:center;">
    <td style="width:2%;font-size:9px;line-height:1.8;">S.N<br>ر.ت</td>
    <td style="line-height:1.3;font-size:9px;">Nature of goods<br>تفاصيل الصنف</td>
    <td style="line-height:1.3;text-align:center;width:6%;font-size:9px;">Quantity<br>الكمية</td>
    <td style="line-height:1.3;text-align:center;width:8.5%;font-size:9px;">Unit price<br>سعر الوحدة<br>(SAR)</td>
    <td style="line-height:1.3;text-align:center;font-size:9px;width:4%;">Unit<br>الوحدة</td>
    <td style="text-align:center;line-height:1.3;width:14.5%;font-size:9px;">Taxable Amount<br>المبلغ الخاضع للضريبة<br>(SAR)</td>
    <td style="text-align:center;line-height:1.3;width:8%;font-size:9px;">Tax Rate<br>نسبة الضريبة</td>
    <td style="text-align:center;line-height:1.3;font-size:9px;width:9.5%;">Tax Amount<br>مبلغ الضريبة<br>(SAR)</td>
    <td style="width:15%;line-height:1.3;font-size:9px;">Subtotal (Including VAT)<br>المجموع (شامل الضريبة)<br>(SAR)</td>
  </tr>

  <!-- Items Loop -->
  {% set total_amount = [0] %}
  {% set i = [1] %}

  {% for item in doc.items %}
    {% if total_amount.append(total_amount.pop() + (item.net_amount or 0)) %}{% endif %}

    {% set item_tax_rate = 0 %}
    {% set item_tax_amount = 0 %}
    {% if doc.taxes and doc.taxes|length > 0 %}
      {% set item_tax_rate = doc.taxes[0].rate or 15 %}
      {% set item_tax_amount = (item.net_amount or 0) * item_tax_rate / 100 %}
    {% endif %}
    {% set item_total = (item.net_amount or 0) + item_tax_amount %}

    <tr>
      <td style="width:2%;font-size:12px;">{{ i[0] }}</td>
      <td style="line-height:1;font-size:12px;">
        <div>{{ item.item_code }}: {{ item.item_name[:80] }}</div>
      </td>
      <td class="ar" style="font-size:12px;text-align:center">
        {% if (item.qty | int) == item.qty %}
          {{ item.qty | int }}
        {% else %}
          {{ item.qty }}
        {% endif %}
      </td>
      <td style="line-height:1;font-size:12px;text-align:center;">{{ "{:,.2f}".format(item.rate) }}</td>
      <td style="line-height:1;font-size:12px;text-align:center;">{{ item.uom }}</td>
      <td class="ar" style="font-size:12px;text-align:center">{{ "{:,.2f}".format(item.net_amount or item.amount) }}</td>
      <td class="ar" style="font-size:12px;text-align:center">{{ item_tax_rate }}%</td>
      <td class="ar" style="font-size:12px;text-align:center">{{ "{:,.2f}".format(item_tax_amount) }}</td>
      <td class="ar" style="font-size:12px;text-align:center">{{ "{:,.2f}".format(item_total) }}</td>
    </tr>

    {% if i.append(i.pop() + 1) %}{% endif %}
  {% endfor %}

  <!-- Cutting Service Section -->
  <tr style="border:none">
    <td colspan="9" style="border:none; background-color:#ffffff">
      <div class="cutting-service-section">
        <span style="font-size:16px; font-weight:bold; color:#2e7d32;">
          خدمة القص مجانية من الشركة / Free Cutting Service from the Company
        </span>
      </div>
    </td>
  </tr>

  <!-- Totals Section with Two Columns -->
  <tr style="border:none">
    <td colspan="9" style="border:none; background-color:#ffffff">
      <table style="width:102%;border:none;margin-left:-6px;margin-top:2px;">
        <tr style="background-color:{{color}};">
          <td colspan="6" style="color:white;line-height:0.8;font-size:14px; border-top-left-radius: 10px; border-top-right-radius: 10px; text-align:center;">
            Total amounts / اجمالي المبالغ
          </td>
        </tr>
        <tr style="background-color: #ffffff !important;">
          <td colspan="6" style="padding:0; border:none;">
            <table style="width:100%; border:none;">
              <tr style="border:none;">
                <!-- Left Column: Totals -->
                <td style="width:50%; vertical-align:top; border:none; padding:5px;">
                  <table style="width:100%; border:none;">
                    <tr style="background-color: #ffffff !important;">
                      <td style="font-size:10px; text-align:left; border:none;">Total (Excluding VAT) / الإجمالي (غير شاملة الضريبة)</td>
                      <td style="font-size:10px; text-align:right; border:none;">SAR {{ "{:,.2f}".format(doc.net_total) }}</td>
                    </tr>
                    {% if doc.discount_amount %}
                    <tr style="background-color: #f3f3f3 !important;">
                      <td style="font-size:10px; text-align:left; border:none;">Discount / مجموع الخصومات</td>
                      <td style="font-size:10px; text-align:right; border:none;">SAR {{ "{:,.2f}".format(doc.discount_amount) }}</td>
                    </tr>
                    {% endif %}
                    <tr style="background-color: #f3f3f3 !important;">
                      <td style="font-size:10px; text-align:left; border:none;">Total VAT / مجموع ضريبة القيمة المضافة</td>
                      <td style="font-size:10px; text-align:right; border:none;">SAR {{ "{:,.2f}".format(doc.total_taxes_and_charges) }}</td>
                    </tr>
                    <tr style="background-color: #ffffff !important;">
                      <td style="font-size:12px; font-weight:bold; text-align:left; border:none;">Total Amount Due / إجمالي المبلغ المستحق</td>
                      <td style="font-size:12px; font-weight:bold; text-align:right; border:none;">SAR {{ "{:,.2f}".format(doc.grand_total) }}</td>
                    </tr>
                    <tr style="background-color: #f3f3f3 !important;">
                      <td colspan="2" style="font-size:10px; text-align:left; border:none;">
                        {% set mon = frappe.utils.money_in_words(doc.grand_total | abs, 'SAR', 'Halala') %}
                        {{ mon }}
                      </td>
                    </tr>
                    <tr style="background-color: #ffffff !important;">
                      <td style="font-size:10px; text-align:left; border:none;">Issued By / تحرر بواسطة:</td>
                      <td style="font-size:10px; text-align:right; border:none;">{{ frappe.db.get_value('User', doc.modified_by, 'full_name') }}</td>
                    </tr>
                  </table>
                </td>
                <!-- Right Column: QR Code -->
                <td style="width:50%; vertical-align:middle; border:none; text-align:center; padding:10px;">
                  {% if doc.ksa_einv_qr %}
                    <img src="{{ doc.ksa_einv_qr }}" alt="QR Code" style="width:140px;height:140px;" />
                  {% endif %}
                </td>
              </tr>
            </table>
          </td>
        </tr>
      </table>
    </td>
  </tr>

</table>

<!-- Fixed Footer at Bottom -->
<div class="fixed-footer">
  <img src="/assets/expenses_management/images/footer.jpeg" alt="Footer" />
</div>
